# Tcp_Relay

## 功能

基于 TCP 长连接模式，实现一个基于Epoll的单线程中继服务器，完成两个通信客户端之间的报文双向转发。开发模拟多客户端的 EPOLL 架构的负载发生器，通过传入会话数量运行参数，模拟多个并发会话(每个会 话包括两个客户端)，每个客户端在内存中生成要转发的字符串数据，通过服务器中继到同一个会话的另外一个客户端（与发送客户端都在同一个发生器进程中），由此产生对服务器持续的数据转发压力。

转发的报文大小可变，也就是说服务器事先不知道收到的报文的长度。一般来说需要自行设计一个报文格式，包含固定长度的报文头部和变长的报文数据，其中头部可以简单地使用C Struct 实现，包含报文类型和报文长度等字段。

暂时不需要考虑报文序列化的问题，可以直接把报头和数据强制转换为char 数组后发送。

压力发生器要支持命令行参数，其中包含：要创建的会话数，发送的报文的大小。

简单来说，中继服务器的工作如下：在一个客户端连接向服务器发送了一个报文后，服务器判断要转发到哪一个客户端连接，然后把报文原样发送过去。
压力发生器的工作如下：与中继服务器建立大量客户端连接（两两组成一个会话），生成指定大小的报文并发送给服务器，在收到经服务器转发的报文后记录报文延迟等数据。

## 性能和可靠性

支持 10000 个以上的客户连接(5000 个以上的会话)同时通信。客户连接以任何形式关闭， 服务器都可以正常回收资源并继续工作，没有内存泄漏或错误。

## 代码质量检查

在功能稳定后，在运行时用 valgrind 检查程序。任意时刻启动或终止负载发生器，valgrind 对服务器程序分析输出均不包括内存泄漏、 越界访问、未初始化读和段错误等出错信息。如果出现错误信息，则根据 valgrind 的检测报告修改代码。

## 性能分析

关闭 valgrind 之后，使用 gprof 工具对程序性能进行综合分析。要求会按照 gprof 手册要求修改 g++编译参数， 能根据 gprof 的输出找出程序代码的瓶颈并优化代码。

## 添加线程池

在单核Epoll版本的中继服务器测试正常后，可以尝试把线程池加入到服务器中，并比较加入线程池前后服务器的性能。
